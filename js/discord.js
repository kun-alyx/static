const MESSAGE_LOAD_LIMIT=150,BASE_TITLE=document.title;let currentChannel,imageFormats=["bmp","gif","ico","jpeg","jpe","jpg","jfif","apng","png","tga","tiff","tif","svg","webp"];const loadMessages=async(e,a=0,n=!1)=>{let t=document.getElementById(`channel-${e}`);if(t.classList.contains("channel-active")&&0==a)return;Array.from(document.querySelectorAll(".channel-active")).forEach((e=>{e.classList.remove("channel-active")})),t.classList.add("channel-active"),window.location.hash=e,document.title=`${t.children[0].textContent} | ${BASE_TITLE}`;const s=document.getElementById("messages"),c=Array.from(s.children).reduce(((e,a)=>e+a.offsetHeight),0),i=document.getElementById("load-more-button");i&&(i.outerHTML=""),currentChannel!==e&&(s.innerHTML=""),currentChannel=e;const o=await fetch(`/api/v1/discord/channel/${e}?o=${a}`).then((e=>e.json()));o.map((e=>{let a="",n="",t="";e.content&&(e.content=e.content.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/"/g,"&quot;").replace(/<br \/>/g,""),e.content=e.content.replace(/&lt;a?:(.+?):(\d+)>/g,'<img class="emoji" title=":$1:" src="https://cdn.discordapp.com/emojis/$2">')),e.attachments.map((e=>{imageFormats.includes(e.name.split(".").pop())?a+=`<a href="/data/${e.path}?f=${e.name}" target="_blank"><img class="user-post-image" style="max-width:300px" src="/thumbnail/data${e.path}" data-tries="2" onerror="if(this.dataset['tries']!='0'){this.src='/data/${e.path}?f=${e.name}';this.dataset['tries']--;}"></a><br>`:a+=`<a href="/data/${e.path}?f=${e.name}">Download ${e.name.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/"/g,"&quot;")}</a><br>`})),e.embeds.map((e=>{t+=`\n        <a href="/data/${e.url}" target="_blank">\n          <div class="embed-view" style="max-width:300px">\n            <p>${(e.description||e.title||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/"/g,"&quot;")}</p>\n          </div>\n        </a>\n      `})),n=e.author.avatar?`https://cdn.discordapp.com/avatars/${e.author.id}/${e.author.avatar}`:"/static/discordgrey.png",s.innerHTML=`\n      <div class="message">\n        <div class="avatar">\n          <img class="avatar" src="${n}" onerror="this.src = '/static/discordgrey.png'" referrerpolicy="no-referrer" alt="">\n        </div>\n        <div style="display:inline-block" id="${e.id}">\n          <div class="message-header">\n            <b><p>${e.author.username.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/"/g,"&quot;")}</p></b>\n            <p style="color:#757575">${new Date(e.published)}</p>\n          </div>\n          <p><pre class="message__body">${e.content}</pre></p>\n          ${a}\n          ${t}\n        </div>\n      </div>\n    `+s.innerHTML})),150==o.length?s.innerHTML=`\n      <div class="message" id="load-more-button">\n        <button onClick="loadMessages('${e}', ${a+150})" class="load-more-button">\n          Load More\n        </button>\n      </div>\n    `+s.innerHTML:s.innerHTML='\n      <div class="message" id="load-more-button">\n        <p>End of channel history</p>\n      </div>\n    '+s.innerHTML,s.scrollTop=s.scrollHeight-c},load=async()=>{const e=window.location.pathname.split("/"),a=await fetch(`/api/v1/discord/channel/lookup/${e[3]}`),n=await a.json(),t=document.getElementById("channels");n.forEach((e=>{document.getElementById(`channel-${e.id}`)||(t.innerHTML+=`\n        <div class="channel" id="channel-${e.id}" onClick="loadMessages('${e.id}')">\n          <p>#${e.name.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/"/g,"&quot;")}</p>\n        </div>\n      `)}));const s=window.location.href.match(/\/discord\/server\/(\d+)/)[1];t.innerHTML+=`\n    <div class="channel" id="linked-accounts" style="position: fixed; bottom: 0;">\n      <a href="/discord/user/${s}/links">Linked Accounts</a>\n    </div>\n  `,""!==window.location.hash&&loadMessages(window.location.hash.slice(1).split("-")[0])};load();